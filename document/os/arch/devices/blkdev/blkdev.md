# 块设备 - ClassiX 文档

> 当前位置: os/arch/devices/blkdev/blkdev.md

## 概述

块设备子系统为 ClassiX 操作系统提供统一的块设备管理接口，抽象软盘、硬盘等存储设备的差异，向上层提供一致的读写接口。

## 核心数据结构（BLKDEV）

### 块设备结构

|字段|类型|描述|
|:-:|:-:|:-:|
|`id`|`uint32_t`|设备 ID（BIOS 设备号）|
|`sector_size`|`uint32_t`|扇区大小（字节）|
|`total_sectors`|`uint32_t`|总扇区数|
|`device`|`void *`|指向具体设备结构|
|`read`|`blkdev_io`|读操作函数指针|
|`write`|`blkdev_io`|写操作函数指针|

### BIOS 设备号

|设备号|描述|
|:-:|:-:|
|`0x00`|第一张软盘（FD0）|
|`0x01`|第二张软盘（FD1）|
|`0x80`|第一块硬盘（HD0）|
|`0x81`|第二块硬盘（HD1）|
|`0x82`|第三块硬盘（HD2）|
|`0x83`|第四块硬盘（HD3）|

### IDE 设备结构

|字段|类型|描述|
|:-:|:-:|:-:|
|`primary`|`bool`|主/从通道|
|`master`|`bool`|主/从设备|
|`type`|`uint8_t`|设备类型|
|`model`|`char[41]`|设备型号|
|`serial`|`char[21]`|序列号|
|`firmware`|`char[9]`|固件版本|
|`sectors`|`uint64_t`|总扇区数|
|`capabilities`|`uint32_t`|设备能力|
|`lba48_supported`|`bool`|LBA48 支持|

### 软盘设备结构

|字段|类型|描述|
|:-:|:-:|:-:|
|`drive`|`uint8_t`|驱动器号 (0-3)|
|`spec`|`FLOPPY_SPEC *`|软盘规格参数指针|

## 错误码定义

|错误码|值|描述|
|:-:|:-:|:-:|
|`BD_SUCCESS`|0|成功|
|`BD_NOT_EXIST`|1|设备不存在|
|`BD_INVALID_PARAM`|2|无效参数|
|`BD_TIMEOUT`|3|超时|
|`BD_NOT_READY`|4|设备未就绪|
|`BD_IO_ERROR`|5|读写错误|
|`BD_READONLY`|6|只读设备|

## 设备注册

通过 `register_blkdevs` 函数注册系统中的块设备，流程如下：

1. 初始化 IDE 设备和软盘设备  
2. 为每个检测到的设备创建 BLKDEV 结构
3. 设置设备操作函数指针
4. 添加到全局设备列表

## 接口

### `register_blkdevs`

注册系统中所有可用的块设备。

**函数原型**

```c
int32_t register_blkdevs(void);
```

|返回值|描述|
|:-:|:-:|
|`int32_t`|成功注册的设备数量|

### `get_device`

根据设备 ID 获取块设备指针。

**函数原型**

```c
BLKDEV *get_device(
	uint32_t dev_id
);
```

|参数|描述|
|:-:|:-:|
|`dev_id`|BIOS 设备号|

|返回值|描述|
|:-:|:-:|
|`BLKDEV *`|块设备指针，不存在返回 `NULL`|

### 块设备操作

所有块设备通过函数指针提供统一的操作接口：

#### 读扇区

**函数原型**

```c
int32_t (*blkdev_io)(
	void *dev,
	uint32_t lba,
	uint32_t count,
	void *buf
);
```

|参数|描述|
|:-:|:-:|
|`dev`|设备特定结构指针|
|`lba`|起始逻辑扇区号|
|`count`|要读取的扇区数|
|`buf`|数据缓冲区指针|

|返回值|描述|
|:-:|:-:|
|错误码|操作结果|

#### 写扇区

**函数原型**

```c  
int32_t (*blkdev_io)(
	void *dev,
	uint32_t lba,
	uint32_t count,
	const void *buf
);
```

|参数|描述|
|:-:|:-:|
|`dev`|设备特定结构指针|
|`lba`|起始逻辑扇区号|
|`count`|要写入的扇区数|
|`buf`|数据缓冲区指针|

|返回值|描述|
|:-:|:-:|
|错误码|操作结果|

对于硬盘，写操作完成后会自动刷新缓存以确保数据一致性。

## 设备规格

### 硬盘规格

|参数|值|说明|
|:-:|:-:|:-:|
|扇区大小|512 字节|标准硬盘扇区大小|
|最大设备数|4|主从通道各 2 个设备|
|LBA 支持|是|支持 28/48 位 LBA|

### 软盘规格

|参数|值|说明|
|:-:|:-:|:-:|
|扇区大小|512 字节|标准软盘扇区大小|
|最大设备数|2|软盘驱动器 A 和 B|
|传输速率|250Kbps-1Mbps|根据软盘类型调整|
